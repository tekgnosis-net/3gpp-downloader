# 3GPP Downloader – Copilot Guide

- **Purpose**: Tooling to scrape ETSI data, curate spec lists, and download PDFs through CLI (`src/main.py`) or Mesop web UI (`src/web_app.py`).
- **Repo layout**: CLI orchestration in `src/main.py`, Mesop components and state in `src/web_app.py`, async download engine in `src/tools/json_downloader.py`, scraping via Scrapy spider in `src/tools/etsi_spider.py`, logging helpers in `src/utils/logging_config.py`.
- **Data pipeline**: CLI exposes `scrape`, `filter`, `download`, and `scrape download` workflows; each stage produces JSON (`links.json`, `latest.json`, `selected.json`) consumed by later steps.
- **Download engine**: `download_from_json` (async) streams files with aiohttp, connection pooling, and retry logic; progress callbacks receive `(filename, status, percent)` and are invoked from event loop threads.
- **Web UI state**: Global `app_state` (instance of `AppState`) tracks selections, statuses, progress, and timestamps. Always mutate via helper functions like `update_download_progress` so `app_state.last_update = time.time()` fires to trigger Mesop re-renders.
- **UI threading model**: Long-running jobs (scrape/filter/download) start in background threads; callbacks must be thread-safe and only touch `app_state` through provided helpers.
- **Mesop quirks**: Component props such as `disabled`, `checked`, and select values must be `int`, not `bool`; follow existing patterns (`int(condition)`) to avoid runtime validation errors.
- **Styling conventions**: Use the `Theme` design system plus helpers like `create_card_style`, `create_button_style`, and `create_status_chip` for consistent appearance. Animations are applied via CSS classes declared in `me.html`.
- **Progress UX**: Determinate bars appear when `app_state.download_progress > 0`; initialization reserves 10%, downloads 80%, completion 10%. Update `app_state.current_operation` to keep status text aligned with progress cards.
- **Settings persistence**: Web controls read and write `web_settings.json`; update `load_saved_settings` and `save_settings` together when adding new preferences.
- **File discovery**: `load_available_files` reads JSON files generated by scraper; keep schema (`series`, `release`, `url`, etc.) consistent between scraper and UI.
- **Logging**: All modules call `setup_logger` with env-configurable levels (`WEB_APP_*`, `MAIN_*`). Honor this pattern when adding new modules so Docker log routing works.
- **Docker workflow**: Primary run path is `docker compose up --build -d` (ports 8081→32123). Containers mount `downloads/` and `logs/` for persistence.
- **Local workflow**: Use `python run_web.py` for Mesop UI or `python -m src.main scrape download` for end-to-end CLI. Virtualenv setup is documented in `README.md`.
- **Testing**: No dedicated suite today; ad-hoc tests run with `pytest`. If adding tests, place them under `tests/` and ensure they work both locally and inside the Docker image.
- **Error handling**: The UI surfaces failures via `show_error_notification`; raise/log detailed messages in backend functions so these notifications stay informative.
- **Adding CLI options**: Extend argparse in `main.py` and thread new flags through `download_data_with_config` / `scrape_data_with_config`; keep defaults synced with UI settings.
- **Extending downloads**: When modifying `download_from_json`, maintain async semantics and the `progress_callback` contract; the web thread expects aggregated progress.
- **Scraper updates**: `tools/etsi_spider.py` drives Scrapy pipelines saved to JSON. Adjust `ITEM_PIPELINES` and `custom_settings` there rather than in the CLI.
- **Code style**: Stick to Python 3.12 features, keep imports alphabetized locally, and respect existing logging, typing, and dotenv patterns.
- **Copilot responses**: Always end with a concise summary of the actions performed and the current status or next steps.
- **Chakra UI refactor**: Active work happens on `feature/chakra-ui-refactor` using a new React/Vite frontend in `frontend/` (Chakra UI + TypeScript). Leave the Mesop UI untouched in this branch.
- **Frontend workflow**: Run `npm install` inside `frontend/`, start dev server with `npm run dev`, and build with `npm run build`. Artifact directories (`dist/`, `.vite/`) stay ignored.
- **API layer**: REST endpoints for the new UI live under `src/api/` (`server.py`, `state_manager.py`). Keep FastAPI-style handlers stateless and thread-safe; persist cross-request data via `state_manager` helpers.
- **Context hand-off**: Each session should confirm outstanding tasks for the Chakra rewrite (e.g., scaffolding components, wiring new endpoints) so the next environment can resume seamlessly.
